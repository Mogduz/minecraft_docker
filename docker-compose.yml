x-minecraft-common: &minecraft-common
  image: ${IMAGE_NAME:-minecraft-java}:${IMAGE_TAG:-1.21.11}
  container_name: ${CONTAINER_NAME:-minecraft-java}
  environment: &minecraft-environment
    EULA: "${EULA:-TRUE}"
    SERVER_TYPE: "${SERVER_TYPE:-vanilla}"
    JVM_OPTS: "${JVM_OPTS:--Xms2G -Xmx4G}"
    RCON_ENABLED: "${RCON_ENABLED:-FALSE}"
    RCON_PASSWORD: "${RCON_PASSWORD:-}"
    RCON_PORT: "${RCON_PORT:-25575}"
  volumes: &minecraft-volumes
    - ./minecraft/config:/data/config
    - ./minecraft/world:/data/world
    - ./minecraft/mods:/data/mods
    - ./minecraft/resourcepacks:/data/resourcepacks
    - ./minecraft/logs:/data/logs
  restart: ${RESTART_POLICY:-unless-stopped}
  stdin_open: true
  tty: true

services:
  minecraft:
    <<: *minecraft-common
    build:
      context: .
      args:
        MC_VERSION: ${MC_VERSION:-1.21.11}
        FABRIC_LOADER_VERSION: ${FABRIC_LOADER_VERSION:-auto}
        FABRIC_INSTALLER_VERSION: ${FABRIC_INSTALLER_VERSION:-auto}
        FORGE_VERSION: ${FORGE_VERSION:-auto}
        NEOFORGE_VERSION: ${NEOFORGE_VERSION:-auto}
    ports:
      - "${MC_PORT:-25565}:25565"

  minecraft-rcon:
    image: alpine/socat:1.8.0.3
    container_name: ${CONTAINER_NAME:-minecraft-java}-rcon
    profiles:
      - rcon
    depends_on:
      - minecraft
    command:
      - "-d"
      - "-d"
      - "TCP-LISTEN:25575,fork,reuseaddr"
      - "TCP:minecraft:${RCON_PORT:-25575}"
    ports:
      - "${RCON_PORT:-25575}:25575"
    restart: ${RESTART_POLICY:-unless-stopped}